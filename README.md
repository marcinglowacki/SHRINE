# SHRINE: Structure maximisation of High-time Resolution Intensity profiles with No-nonsense Errors

As described in Sutinjo et al. 2023: 

https://ui.adsabs.harvard.edu/abs/2023ApJ...954...37S/abstract 

10.3847/1538-4357/ace774

------------------------

# Primary code by Timothy Perrott

Based on earlier code by Adrian Sutinjo, and a script originally by Danica Scott

Some additions by Apurba Bera and Marcin Glowacki

Also part of CELEBI (see unified branch): https://github.com/askap-craco/CELEBI/tree/main

------------------------

# Requirements (listed as module load options for OzSTAR/NT; load up equivalents otherwise):

java/17.0.4

gcc/11.3.0 openmpi/4.1.4

python/3.10.4

numpy/1.22.3-scipy-bundle-2022.05

matplotlib/3.5.2

scipy/1.8.1-scipy-bundle-2022.05

nextflow/23.04.2

------------------------

# Usage

1. Load java/17.0.4 or run '. setup.sh'
        (nextflow should be able to handle loading python et al, but setup.sh should suffice if not)

2a. Run with './nextflow optimise_DM.nf --label <FRB label>' for a very fast, very coarse estimate over a large range

2b. Run with parameters below for finer calculations

3. Outputs (see below) will be under /dm_processing/output/<FRB label>/

Arguments
    From Command line:
    --label <value>
        FRB Label. Required.

    --dm_low <value>
    --dm_high <value>
        Lower and upper bounds of delta DM range, respectively.
        Optional, defaults to -5 and 5 respectively.

    --dm_step <value>
    --dm_count <value>
        Two methods of defining delta DM resolution.
        Step divides the delta DM range into steps of the given size.
        Count divides the range into the given number of steps.
        If both are provided, dm_count takes priority.
        Optional, dm_step defaults to 0.1, dm_count defaults to 0

    --timescale <value>
        Time resolution in us to scrunch data to.
        Optional, defaults to 1.

    --bandwidth <value>
        Bandwidth in Mhz
        Optional, defaults to 336

    --force_kc <value>
        Provide a value of kc for the low pass filter, rather than calculate it.
        Optional, defaults to false.

    --do_vary_kc
        If provided, generate plots showing impact of kc variation.
        Generating these involves running maximise_structure many times, and can take a while.
        Optional, defaults to false.

    --do_uncertainty_min
        If provided, calculates a value for kc that minimises uncertainty.
        Takes as much time as do_vary_kc above.
        Optional, defaults to false.

    --do_sn
        If provided, also calculates a signal to noise maximising delta DM
        Optional, defaults to false.

    --saving
        If true, saves plots.
        Optional, defaults to true.

    From nextflow.config:
    params.configs
        Path to the folder containing the external config file.
    params.data
        Path to the folder containing the X and Y time series.
    - Note, running with profile manual_config will stop nextflow from looking for a config file. 
    In this case the above parameters will have to be provided manually.
    
    From External Config File:
    params.dm_frb
        Dispersion measure to which the X and Y time series have been dedispersed.
    params.centre_freq_frb
        Central frequency in MHz

Timings (processing on a login node)
    Time taken for a full run (with do_vary_kc, do_sn and do_uncertainty_min) scales approximately linearly with DM.
    For a normal 10ms crop at 1us time resolution, an estimate of 3s per DM step should be a good upper bound prediction of run time
    40-50% of the total run time is taken up by generate_profiles.
    Increasing timescale does not reduce the run time of generate_profiles, but does speed up all other processes, with diminishing returns.

Outputs:
    maximise_structure (default):
        ..._structure_summaryfile.txt
        txt file containing various bits of information calculated.
        Includes TODO

        ..._DM_index.png
        Plot of delta DM vs DM index. Only useful for visualising a hypothetical non-linear DM set.

        ..._I_DM_t.png
        Plot of I against DM and t. The profile generated by generate_profiles.

        ..._I_DM_t_smoothed.png
        The above for the smoothed data.

        ..._detrended_noise.png
        The above for the detrended noise.

        ..._relative_detrended_noise.png
        The above for the relative detrended noise.

        ..._I_max.png
        Plot of I against t. Shows intensity time series (smoothed and unsmoothed) at structure maximising delta DM.

        ..._noise_max.png
        Plot of I against T. Shows intensity time series of the noise at structure maximising delta DM.

        ..._structure_SN_comparison.png
        Plot of I against t. Shows intensity time series of the signal at the both the structure maximising and signal to noise maximising delta DMs

        ..._uncertainty.png
        Plot of uncertainty in structure parameter.

        ..._relative_uncertainty.png
        Plot of uncertainty in structure parameter relative to structure parameter at structure maximising delta DM.

        ..._DCT_v_k_index.png
        Plot of the discrete cosine transformed data, with the selected kc value drawn as a vertical line.

        ...structure_parameter.png
        Plot of structure parameter vs delta DM.

        ..._adjusted_SP.png
        Plot of structure parameter scaled up by relative uncertainty.

    maximise_sn (--do_sn)
        ..._SN_summaryfile.txt
        Summary of SN related results.
        Includes delta DM and index of max SN, window over which it was calculated, and calculated max SNR.

        ..._SN.png
        Plot of maximum signal to noise ratio vs delta DM.

        ..._Max_SN_window.png
        Intensity time plot at the signal to noise ratio maximising delta DM, with 'signal' region highlighted.

    minimise_uncertainty (--do_uncertainty_min OR --do_vary_kc)
        ..._kc_var_uncertainty.png
        Plot of the structure maximising DM (solid line) and the upper and lower bounds of its uncertainty (dashed lines) with respect to kc

    vary_kc (--do_vary_kc)
        ..._varied_kc_SPs.png
        Very pretty plot of structure parameter vs delta DM for various values of kc above and below the calculated (or forced) kc

Credits:
    Most of maximise_structure (and varying amounts of maximise_sn, minimise_uncertainty and dm_processing) was adapted from a jupyter notebook written by Adrian Sutinjo (see 'Calculation and Uncertainty of Fast Radio Burst Structure Based on Smoothed Data' whenever published)
    
    generate_profiles adapted from a standalone python script written by Danica Scott.

    Nextflow script, adaptation of the above, structure_SN_comparison, get_kc and get_ranges_above_max from dm_processing, and initial README done by Timothy Perrett.
